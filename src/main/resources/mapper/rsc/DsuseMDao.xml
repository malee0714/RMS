<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="lims.rsc.dao.DsuseMDao">
	<!-- 조회 -->
	<sql id="bplcCode">'${@lims.util.GetUserSession@getBestInspctInsttCode()}'</sql>
	<select id="getDsuseBacode" parameterType="lims.rsc.vo.DsuseMVo" resultType="lims.rsc.vo.DsuseMVo" >
		SELECT
		RP.CUSTLAB_SEQNO,
		RPWB.PRDUCT_WRHSDLVR_BRCD_SEQNO,
		RPWB.PRDUCT_WRHSDLVR_SEQNO ,
		RPWB.PRDUCT_SEQNO ,
		RPWB.BRCD ,
		VALID_TMLMT_MTHD_CODE,
		UNSEAL_AFTER_TMLMT,
		CYCLE_CODE,
		RPWB.VALID_DTE,
		CASE
		WHEN RP.VALID_TMLMT_MTHD_CODE = 'RS15000001' THEN (SELECT CMMN_CODE_NM
		FROM SY_CMMN_CODE WHERE cmmn_code =RP.VALID_TMLMT_MTHD_CODE)
		||RP.UNSEAL_AFTER_TMLMT
		WHEN VALID_TMLMT_MTHD_CODE = 'RS15000002' THEN (SELECT CMMN_CODE_NM FROM
		SY_CMMN_CODE WHERE cmmn_code =RP.VALID_TMLMT_MTHD_CODE)
		||RP.UNSEAL_AFTER_TMLMT||
		(SELECT CMMN_CODE_NM FROM SY_CMMN_CODE WHERE cmmn_code =RP.CYCLE_CODE)
		END AS VALIDDATE,
		RPWB.LAST_CHANGER_ID,
		RPWB.LAST_CHANGE_DT,
		RPWB.BPLC_CODE,
		RP.PRDUCT_CL_CODE,
		RP.PRDUCT_NM,
		RP.PRDUCT_PRPOS,
		RP.CPCTY,
		RP.USE_PURPS,
		RPWB.WRHSDLVR_SE_CODE,
		RPW.RM,
		RP.NOW_INVNTRY_QY,
		RPW.PACKNG_STTUS
		FROM RS_PRDUCT_WRHSDLVR_BRCD RPWB
		JOIN RS_PRDUCT_WRHSDLVR RPW ON RPW.PRDUCT_WRHSDLVR_SEQNO=RPWB.PRDUCT_WRHSDLVR_SEQNO
		JOIN RS_PRDUCT RP ON RP.PRDUCT_SEQNO =RPWB.PRDUCT_SEQNO
		WHERE RPWB.BRCD = TRIM (#{brcd})AND RPWB.DELETE_AT ='N' AND RP.USE_AT ='Y'
			AND RPWB.BPLC_CODE = <include refid="bplcCode"/>
	</select>	
</mapper>