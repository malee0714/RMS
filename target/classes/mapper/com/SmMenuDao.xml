<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="lims.com.dao.SmMenuDao">

	<!-- 계층형 북마크메뉴 쿼리블록 -->
	<sql id="bookMarkMenuByLv">
		WITH T AS (
			-- 북마크에 등록된 3차메뉴
			SELECT
				A.MENU_SEQNO
				,A.UPPER_MENU_SEQNO
				,A.MENU_NM
				,A.MENU_URL
				,A.SORT_ORDR
				,A.USE_AT
				,A.CTMMNY_OTHBC_AT
			FROM SY_MENU A
			JOIN SY_MENU_BKMK B ON A.MENU_SEQNO = B.MENU_SEQNO AND B.USER_ID = #{userId}

			UNION

			SELECT 100000, NULL, 'My', '', 100000, 'Y', 'Y' FROM DUAL -- 임의로 지정한 북마크 최상위메뉴 (upperMenu X)

			UNION

			-- 북마크에 등록된 메뉴의 2차메뉴
			SELECT
				SM.MENU_SEQNO
				,SM.UPPER_MENU_SEQNO
				,SM.MENU_NM
				,SM.MENU_URL
				,SM.SORT_ORDR
				,SM.USE_AT
				,SM.CTMMNY_OTHBC_AT
			FROM SY_MENU SM
			WHERE MENU_SEQNO IN (
				SELECT DISTINCT A.UPPER_MENU_SEQNO FROM SY_MENU A
				JOIN SY_MENU_BKMK B ON A.MENU_SEQNO = B.MENU_SEQNO AND B.USER_ID = #{userId}
			)

			UNION

			-- 북마크에 등록된 메뉴의 1차메뉴
			SELECT
				MENU_SEQNO
				,100000 -- 'My' 메뉴의 하위로 지정
				,MENU_NM
				,MENU_URL
				,SORT_ORDR
				,USE_AT
				,CTMMNY_OTHBC_AT
			FROM SY_MENU
			WHERE MENU_SEQNO IN (
				SELECT SM.UPPER_MENU_SEQNO FROM SY_MENU SM
				 WHERE MENU_SEQNO IN (
					SELECT DISTINCT A.UPPER_MENU_SEQNO FROM SY_MENU A
					JOIN SY_MENU_BKMK B ON A.MENU_SEQNO = B.MENU_SEQNO AND B.USER_ID = #{userId}
				 )
			)
		)
	</sql>

	<!-- Header 메뉴 조회 -->
	<select id="getTopMenu" parameterType="lims.sys.vo.MenuMVo" resultType="lims.sys.vo.MenuMVo">
		SELECT
			MENU.MENU_SEQNO
			,MENU.UPPER_MENU_SEQNO
			,NVL(SLM.LANG_NM, MENU.MENU_NM) AS MENU_NM
			,SLM.NATION_LANG_CODE
			,MENU.MENU_NM
			,MENU.MENU_DC
			,(SELECT X.MENU_URL FROM SY_MENU X JOIN (
				SELECT
					DISTINCT SM.MENU_SEQNO
					,MIN(SM.SORT_ORDR) OVER(PARTITION BY SM.UPPER_MENU_SEQNO ORDER BY SM.UPPER_MENU_SEQNO, SM.SORT_ORDR) AS SORT_ORDR
				FROM SY_MENU SM
				WHERE SM.USE_AT = 'Y'
				  AND SM.UPPER_MENU_SEQNO IS NOT NULL
				START WITH SM.MENU_SEQNO IN (
					SELECT MENU_SEQNO FROM SY_AUTHOR_MENU
					 WHERE AUTHOR_CODE IN (
						SELECT AUTHOR_CODE FROM SY_AUTHOR_USER
						 WHERE USER_ID IN (SELECT TO_NUMBER(#{userId}) FROM DUAL)
					 )
				)
				CONNECT BY SM.MENU_SEQNO = PRIOR SM.UPPER_MENU_SEQNO
			) SUB1 ON X.MENU_SEQNO = SUB1.MENU_SEQNO AND X.SORT_ORDR = SUB1.SORT_ORDR
			WHERE CONNECT_BY_ISLEAF = 1 AND ROWNUM = 1
			CONNECT BY PRIOR X.MENU_SEQNO = X.UPPER_MENU_SEQNO
			START WITH X.UPPER_MENU_SEQNO = MENU.MENU_SEQNO) AS MENU_URL
			,(SELECT X.MENU_SEQNO FROM SY_MENU X JOIN (
				SELECT
					DISTINCT SM.MENU_SEQNO
					,MIN(SM.SORT_ORDR) OVER(PARTITION BY SM.UPPER_MENU_SEQNO ORDER BY SM.UPPER_MENU_SEQNO, SM.SORT_ORDR) AS SORT_ORDR
				FROM SY_MENU SM
				WHERE SM.USE_AT = 'Y'
				  AND SM.UPPER_MENU_SEQNO IS NOT NULL
				START WITH SM.MENU_SEQNO IN (
					SELECT MENU_SEQNO FROM SY_AUTHOR_MENU
					 WHERE AUTHOR_CODE IN (
						SELECT AUTHOR_CODE FROM SY_AUTHOR_USER
						 WHERE USER_ID IN (SELECT TO_NUMBER(#{userId}) FROM DUAL)
					 )
				)
				CONNECT BY SM.MENU_SEQNO = PRIOR SM.UPPER_MENU_SEQNO
			) SUB2 ON X.MENU_SEQNO = SUB2.MENU_SEQNO AND X.SORT_ORDR = SUB2.SORT_ORDR
			WHERE CONNECT_BY_ISLEAF = 1 AND ROWNUM = 1
			CONNECT BY PRIOR X.MENU_SEQNO = X.UPPER_MENU_SEQNO
			START WITH X.UPPER_MENU_SEQNO = MENU.MENU_SEQNO) AS MENU_CHILD_SEQNO
			,MENU.SORT_ORDR
			,MENU.USE_AT
			,MENU.MNL_USE_AT
		FROM SY_MENU MENU
		LEFT JOIN SY_LANG_MENU SLM ON MENU.MENU_SEQNO = SLM.MENU_SEQNO AND SLM.NATION_LANG_CODE = #{langCode}
		RIGHT JOIN (
			SELECT SM.MENU_SEQNO FROM SY_MENU SM
			 WHERE SM.USE_AT = 'Y'
			   AND SM.UPPER_MENU_SEQNO IS NOT NULL
			 START WITH SM.MENU_SEQNO IN (
				SELECT MENU_SEQNO FROM SY_AUTHOR_MENU
				 WHERE AUTHOR_CODE IN (
					SELECT AUTHOR_CODE FROM SY_AUTHOR_USER
					 WHERE USER_ID IN (SELECT TO_NUMBER(#{userId}) FROM DUAL)
				 )
			 )
			 CONNECT BY SM.MENU_SEQNO = PRIOR SM.UPPER_MENU_SEQNO
			 GROUP BY SM.MENU_SEQNO
		) AUTHOR_MENU ON MENU.MENU_SEQNO = AUTHOR_MENU.MENU_SEQNO
		WHERE MENU.UPPER_MENU_SEQNO IN ('5')
		<if test="auditAt == 'Y'.toString()">
		  AND MENU.CTMMNY_OTHBC_AT = 'Y'
		</if>

		UNION

		SELECT
			100000 -- 북마크메뉴 sequence 임의로 지정
			,5
			,'My'
			,''
			,'My'
			,''
			,(SELECT MENU_URL FROM (
					<include refid="bookMarkMenuByLv"/>

					SELECT
						CASE WHEN INSTR(T.MENU_URL, 'board') > 0
							 THEN T.MENU_URL || CHR(38) || 'bookmark=true'
							 ELSE T.MENU_URL || CHR(63) || 'bookmark=true'
						END AS MENU_URL -- 북마크 사이드메뉴를 유지하기 위한 URL 쿼리스트링 추가
					FROM T
					WHERE T.MENU_SEQNO IN (
						SELECT T.MENU_SEQNO FROM T
						 WHERE T.USE_AT = 'Y'
						   AND T.UPPER_MENU_SEQNO IS NOT NULL
					  	 START WITH T.MENU_SEQNO IN (
							 SELECT MENU.MENU_SEQNO FROM SY_AUTHOR_MENU MENU
							 JOIN T ON MENU.MENU_SEQNO = T.MENU_SEQNO -- 사용자 권한이 변경될 경우를 고려해 북마크메뉴를 JOIN
							 WHERE AUTHOR_CODE IN (
								 SELECT AUTHOR_CODE FROM SY_AUTHOR_USER
								 WHERE USER_ID IN (SELECT TO_NUMBER(#{userId}) FROM DUAL)
							 )
						 )
						 CONNECT BY T.MENU_SEQNO = PRIOR T.UPPER_MENU_SEQNO
					)
					AND LEVEL != 2 AND T.MENU_URL IS NOT NULL
					START WITH T.MENU_SEQNO = 100000
					CONNECT BY PRIOR T.MENU_SEQNO = T.UPPER_MENU_SEQNO
					ORDER SIBLINGS BY T.SORT_ORDR
			  ) WHERE ROWNUM = 1)
			,1
			,100000
			,'Y'
			,'Y'
		FROM DUAL
		ORDER BY SORT_ORDR
	</select>

	<!-- 북마크 사이드메뉴 조회 -->
	<select id="getBkmkLeftMenu" parameterType="lims.sys.vo.MenuMVo" resultType="lims.sys.vo.MenuMVo">
		<include refid="bookMarkMenuByLv"/>

		SELECT
			T.MENU_SEQNO
			,CASE WHEN LEVEL = 3
				  THEN 100000
				  ELSE T.UPPER_MENU_SEQNO END AS UPPER_MENU_SEQNO -- 사이드메뉴 jsp에 JSTL 분기조건에 맞춰주기 위함
			,CASE WHEN T.MENU_URL IS NOT NULL
				  THEN (CASE WHEN INSTR(T.MENU_URL, 'board') > 0
							 THEN T.MENU_URL || CHR(38) || 'bookmark=true'
							 ELSE T.MENU_URL || CHR(63) || 'bookmark=true'
				      	END)
				  ELSE T.MENU_URL END AS MENU_URL -- 북마크 사이드메뉴를 유지하기 위한 URL 파라미터값 추가
			,NVL(SLM.LANG_NM, T.MENU_NM) AS MENU_NM
			,SLM.NATION_LANG_CODE
			,T.MENU_NM
			,T.SORT_ORDR
			,T.CTMMNY_OTHBC_AT
		FROM T
		LEFT JOIN SY_LANG_MENU SLM ON T.MENU_SEQNO = SLM.MENU_SEQNO AND SLM.NATION_LANG_CODE = #{langCode}
		WHERE T.MENU_SEQNO IN (
			SELECT T.MENU_SEQNO FROM T
			 WHERE T.USE_AT = 'Y'
			   AND T.UPPER_MENU_SEQNO IS NOT NULL
			 START WITH T.MENU_SEQNO IN (
				SELECT MENU.MENU_SEQNO FROM SY_AUTHOR_MENU MENU
				JOIN T ON MENU.MENU_SEQNO = T.MENU_SEQNO -- 사용자 권한이 변경될 경우를 고려해 북마크메뉴를 JOIN
				WHERE AUTHOR_CODE IN (
					SELECT AUTHOR_CODE FROM SY_AUTHOR_USER
					 WHERE USER_ID IN (SELECT TO_NUMBER(#{userId}) FROM DUAL)
				)
			 )
			 CONNECT BY T.MENU_SEQNO = PRIOR T.UPPER_MENU_SEQNO
		)
		AND LEVEL != 2
		<if test="auditAt == 'Y'.toString()">
		AND T.CTMMNY_OTHBC_AT = 'Y'
		</if>
		START WITH T.MENU_SEQNO = 100000
		CONNECT BY PRIOR T.MENU_SEQNO = T.UPPER_MENU_SEQNO
		ORDER SIBLINGS BY T.SORT_ORDR
	</select>

	<!-- 일반 사이드메뉴 조회 -->
	<select id="getLeftMenu" parameterType="lims.sys.vo.MenuMVo" resultType="lims.sys.vo.MenuMVo">
		SELECT
			MENU.MENU_SEQNO
			,MENU.UPPER_MENU_SEQNO
			,MENU.MENU_URL
			,NVL(SLM.LANG_NM, MENU.MENU_NM) AS MENU_NM
			,SLM.NATION_LANG_CODE
			,MENU.MENU_NM
			,LEVEL
		FROM SY_MENU MENU
		LEFT OUTER JOIN SY_LANG_MENU SLM ON MENU.MENU_SEQNO = SLM.MENU_SEQNO AND SLM.NATION_LANG_CODE = #{langCode}
		WHERE MENU.MENU_SEQNO IN (
			SELECT SA.MENU_SEQNO FROM SY_MENU SA
			 WHERE SA.USE_AT = 'Y'
			   AND SA.UPPER_MENU_SEQNO IS NOT NULL
			 START WITH SA.MENU_SEQNO IN (
				SELECT MENU_SEQNO FROM SY_AUTHOR_MENU
				 WHERE AUTHOR_CODE IN (
					SELECT AUTHOR_CODE FROM SY_AUTHOR_USER
					 WHERE USER_ID IN (SELECT TO_NUMBER(#{userId}) FROM DUAL)
				 )
			 )
			 CONNECT BY SA.MENU_SEQNO = PRIOR SA.UPPER_MENU_SEQNO
		)
		<if test="auditAt == 'Y'.toString()">
		  AND MENU.CTMMNY_OTHBC_AT = 'Y'
		</if>
		START WITH MENU.MENU_SEQNO = #{menuSeqno}
		CONNECT BY PRIOR MENU.MENU_SEQNO = UPPER_MENU_SEQNO
		ORDER SIBLINGS BY SORT_ORDR
	</select>

	<!-- 북마크메뉴 계층 1row로 조회 -->
	<select id="getBkmkMenuByUrl" parameterType="lims.sys.vo.MenuMVo" resultType="lims.sys.vo.MenuMVo">
		WITH T AS (
			-- 북마크에 등록된 3차메뉴
			SELECT
				A.MENU_SEQNO
				,A.UPPER_MENU_SEQNO
				,A.MENU_NM
				,A.MENU_URL
				,A.SORT_ORDR
				,A.USE_AT
				,A.CTMMNY_OTHBC_AT
			FROM SY_MENU A
			JOIN SY_MENU_BKMK B ON ((A.MENU_SEQNO = B.MENU_SEQNO OR A.MENU_URL = #{menuUrl}) AND B.USER_ID = #{userId})

			UNION

			SELECT 100000, 5, 'My', '', 100000, 'Y', 'Y' FROM DUAL -- 임의로 지정한 북마크 1차메뉴 (최상위메뉴의 하위메뉴로 지정)

			UNION

			-- 북마크에 등록된 메뉴의 2차메뉴
			SELECT
				SM.MENU_SEQNO
				,100000
				,SM.MENU_NM
				,SM.MENU_URL
				,SM.SORT_ORDR
				,SM.USE_AT
				,SM.CTMMNY_OTHBC_AT
			FROM SY_MENU SM
			WHERE (MENU_SEQNO IN (
				SELECT DISTINCT A.UPPER_MENU_SEQNO FROM SY_MENU A
				JOIN SY_MENU_BKMK B ON ((A.MENU_SEQNO = B.MENU_SEQNO OR A.MENU_URL = #{menuUrl}) AND B.USER_ID = #{userId})
			))
		)

		SELECT
			MAX(DECODE(LEVEL,1,NVL(SLM.LANG_NM,T.MENU_NM)))MENU_NM4
			,MAX(DECODE(LEVEL,1,T.MENU_SEQNO))MENU_CD4 -- 북마크 3차메뉴
			,MAX(DECODE(LEVEL,2,NVL(SLM.LANG_NM,T.MENU_NM)))MENU_NM3
			,MAX(DECODE(LEVEL,2,T.MENU_SEQNO))MENU_CD3 -- 북마크 2차메뉴
			,MAX(DECODE(LEVEL,3,NVL(SLM.LANG_NM,T.MENU_NM)))MENU_NM2
			,MAX(DECODE(LEVEL,3,T.MENU_SEQNO))MENU_CD2 -- 북마크 1차메뉴
			,MAX(DECODE(LEVEL,4,NVL(SLM.LANG_NM,T.MENU_NM)))MENU_NM1
			,MAX(DECODE(LEVEL,4,T.MENU_SEQNO))MENU_CD1
		FROM T
		LEFT JOIN SY_LANG_MENU SLM ON T.MENU_SEQNO = SLM.MENU_SEQNO AND SLM.NATION_LANG_CODE = #{langCode}
		WHERE T.USE_AT = 'Y'
		START WITH T.MENU_URL = #{menuUrl}
		CONNECT BY PRIOR T.UPPER_MENU_SEQNO = T.MENU_SEQNO
	</select>

	<!-- 일반메뉴 계층 1row로 조회 -->
	<select id="getMenuByUrl" parameterType="lims.sys.vo.MenuMVo" resultType="lims.sys.vo.MenuMVo">
		SELECT
			MAX(DECODE(LEVEL,1,NVL(SLM.LANG_NM,SM.MENU_NM)))MENU_NM4,
			MAX(DECODE(LEVEL,1,SM.MENU_SEQNO))MENU_CD4,
			MAX(DECODE(LEVEL,2,NVL(SLM.LANG_NM,SM.MENU_NM)))MENU_NM3,
			MAX(DECODE(LEVEL,2,SM.MENU_SEQNO))MENU_CD3,
			MAX(DECODE(LEVEL,3,NVL(SLM.LANG_NM,SM.MENU_NM)))MENU_NM2,
			MAX(DECODE(LEVEL,3,SM.MENU_SEQNO))MENU_CD2,
			MAX(DECODE(LEVEL,4,NVL(SLM.LANG_NM,SM.MENU_NM)))MENU_NM1,
			MAX(DECODE(LEVEL,4,SM.MENU_SEQNO))MENU_CD1
		FROM SY_MENU SM
		LEFT OUTER JOIN SY_LANG_MENU SLM ON SM.MENU_SEQNO = SLM.MENU_SEQNO AND SLM.NATION_LANG_CODE = #{langCode}
		WHERE SM.USE_AT = 'Y'
		START WITH SM.MENU_URL = #{menuUrl}
		CONNECT BY PRIOR SM.UPPER_MENU_SEQNO = SM.MENU_SEQNO
	</select>

	<!-- 메뉴 접근이력 등록 -->
	<insert id="instMenuHist" parameterType="lims.sys.vo.MenuMVo">
		INSERT INTO	AT_MENU_USE_HIST (
			HIST_SEQNO
			,USER_ID
			,USE_DT
			,MENU_SEQNO
			,LAST_CHANGER_ID
			,LAST_CHANGE_DT
			,MENU_URL
		) VALUES (
			SQ_AT_MENU_USE_HIST.NEXTVAL
			,#{userId}
			,SYSDATE
			,#{menuSeqno}
			,#{userId}
			,SYSDATE
			,#{menuUrl}
		)
	</insert>

</mapper>
